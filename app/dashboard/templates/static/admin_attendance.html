<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é - Teacher Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Include our modern dark CSS -->
    <link rel="stylesheet" href="/templates/static/css/modern-dark.css">
    <!-- Include any existing CSS as a fallback -->
    <link rel="stylesheet" href="/templates/static/css/modernized.css">
</head>
<body>
<div class="container">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é</h1>

    <div class="card filter-section mb-6">
        <h2 class="filter-title mb-4">–§–∏–ª—å—Ç—Ä—ã</h2>
        <form method="GET" class="filter-form">
            <div class="filter-row">
                <div class="form-group mb-0">
                    <label for="teacher-filter">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</label>
                    <select name="teacher_id" id="teacher-filter" class="form-control" onchange="this.form.submit()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è --</option>
                        {{range .TeacherList}}
                        <option value="{{.ID}}" {{if eq (printf "%d" .ID) $.SelectedTeacherID}}selected{{end}}>{{.FIO}}</option>
                        {{end}}
                    </select>
                </div>

                {{if .SelectedTeacherID}}
                <div class="form-group mb-0">
                    <label for="group-filter">–ì—Ä—É–ø–ø–∞:</label>
                    <select name="group" id="group-filter" class="form-control" onchange="this.form.submit()">
                        <option value="">-- –í—Å–µ –≥—Ä—É–ø–ø—ã --</option>
                        {{range .Groups}}
                        <option value="{{.}}" {{if eq . $.SelectedGroup}}selected{{end}}>{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                {{if and .SelectedTeacherID .SelectedGroup}}
                <div class="form-group mb-0">
                    <label for="subject-filter">–ü—Ä–µ–¥–º–µ—Ç:</label>
                    <select name="subject" id="subject-filter" class="form-control" onchange="this.form.submit()">
                        <option value="">-- –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã --</option>
                        {{range .Subjects}}
                        <option value="{{.}}" {{if eq . $.SelectedSubject}}selected{{end}}>{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">
                    <span>üîç</span> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
                {{if or .SelectedTeacherID .SelectedGroup .SelectedSubject}}
                <a href="/admin/attendance" class="btn btn-secondary">
                    <span>‚ôªÔ∏è</span> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </a>
                {{end}}
            </div>
        </form>
    </div>

    {{if .AttendanceData}}
    <div class="export-header d-flex justify-between align-items-center mb-4">
        <h2 class="section-title mb-0">
            –î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
            {{if .SelectedGroup}}
            <span class="badge badge-primary">–ì—Ä—É–ø–ø–∞ {{.SelectedGroup}}</span>
            {{else}}
            <span class="badge badge-secondary">–í—Å–µ –≥—Ä—É–ø–ø—ã</span>
            {{end}}
        </h2>

        <a href="/admin/attendance/export?teacher_id={{.SelectedTeacherID}}{{if .SelectedGroup}}&group={{.SelectedGroup}}{{end}}{{if .SelectedSubject}}&subject={{.SelectedSubject}}{{end}}" class="btn btn-info">
            <span>üìä</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        </a>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                <th>–ì—Ä—É–ø–ø–∞</th>
                <th>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            {{range .AttendanceData}}
            <tr>
                <td>{{.Date}}</td>
                <td>{{.Subject}}</td>
                <td>{{.GroupName}}</td>
                <td>
                    <div class="attendance-display">
                        {{$percentage := divideAndMultiply .AttendedStudents .TotalStudents 100}}
                        <div class="attendance-numbers">{{.AttendedStudents}}/{{.TotalStudents}}</div>
                        <div class="attendance-bar">
                            <div class="attendance-progress {{if ge $percentage 80}}high-attendance{{else if ge $percentage 50}}medium-attendance{{else}}low-attendance{{end}}"
                                 style="width: {{printf "%.1f" $percentage}}%;">
                        </div>
                    </div>
                    <div class="attendance-percent">{{printf "%.1f" $percentage}}%</div>
    </div>
    </td>
    <td>
        <div class="action-buttons">
            <a href="/admin/attendance/view/{{.LessonID}}" class="btn btn-sm btn-secondary">
                <span>üëÅÔ∏è</span> –ü—Ä–æ—Å–º–æ—Ç—Ä
            </a>
            <a href="/admin/attendance/edit/{{.LessonID}}" class="btn btn-sm btn-edit">
                <span>‚úèÔ∏è</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <button type="button" class="btn btn-sm btn-danger delete-attendance" data-id="{{.LessonID}}" data-date="{{.Date}}">
                <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </td>
    </tr>
    {{end}}
    </tbody>
    </table>
</div>
{{else if .SelectedTeacherID}}
{{if .SelectedGroup}}
<div class="empty-state card p-6 text-center">
    <div class="empty-state-icon mb-4">üìã</div>
    <h3>–î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
    <p class="text-muted mb-4">–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</p>
    <a href="/admin/attendance/add/{{.SelectedTeacherID}}{{if .SelectedGroup}}/{{.SelectedGroup}}{{end}}" class="btn btn-primary">
        <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
    </a>
</div>
{{else}}
<div class="empty-state card p-6 text-center">
    <div class="empty-state-icon mb-4">üë•</div>
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</h3>
    <p class="text-muted mb-4">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</p>
</div>
{{end}}
{{else}}
<div class="empty-state card p-6 text-center">
    <div class="empty-state-icon mb-4">üë®‚Äçüè´</div>
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h3>
    <p class="text-muted mb-4">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</p>
</div>
{{end}}

<div class="btn-group mt-6">
    <a href="/admin" class="btn btn-secondary">
        <span>üè†</span> –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    </a>
</div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title text-danger">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
            <button type="button" class="close-btn" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –∑–∞ <span id="deleteDate" class="font-bold"></span>?</p>
            <p class="text-danger mt-2">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–æ.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelDelete">–û—Ç–º–µ–Ω–∞</button>
            <form id="deleteForm" method="POST">
                <input type="hidden" id="deleteAttendanceId" name="attendance_id" value="">
                <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<div class="user-info">
    {{if .User.ID}}
    –§–ò–û: {{.User.FIO}} | –†–æ–ª—å: {{.User.Role}} | ID: {{.User.ID}}
    {{end}}
</div>

<!-- Add JavaScript files at the bottom -->
<script src="/templates/static/js/main.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Delete attendance functionality
        const deleteButtons = document.querySelectorAll('.delete-attendance');
        const deleteModal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');
        const deleteAttendanceId = document.getElementById('deleteAttendanceId');
        const deleteDate = document.getElementById('deleteDate');
        const closeModalBtn = document.getElementById('closeModal');
        const cancelDeleteBtn = document.getElementById('cancelDelete');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const date = this.getAttribute('data-date');

                if (deleteAttendanceId) deleteAttendanceId.value = id;
                if (deleteDate) deleteDate.textContent = date;
                if (deleteModal) deleteModal.style.display = 'flex';
            });
        });

        // Close modal functions
        const closeModal = function() {
            if (deleteModal) deleteModal.style.display = 'none';
        };

        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeModal);

        // Click outside modal to close
        window.addEventListener('click', function(event) {
            if (event.target === deleteModal) closeModal();
        });

        // Animate attendance bars
        const progressBars = document.querySelectorAll('.attendance-progress');
        setTimeout(() => {
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.transition = 'width 1s ease-out';
                    bar.style.width = width;
                }, 100);
            });
        }, 200);
    });
</script>

<style>
    .filter-section {
        border-left: 4px solid var(--accent-color);
    }

    .filter-title {
        color: var(--text-primary);
        margin-bottom: var(--space-4);
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .filter-actions {
        display: flex;
        gap: var(--space-3);
    }

    .form-group {
        flex: 1;
        min-width: 200px;
    }

    .section-title {
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .attendance-display {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .attendance-numbers {
        font-family: var(--font-mono);
        font-weight: 600;
        min-width: 45px;
    }

    .attendance-bar {
        height: 8px;
        width: 100px;
        background-color: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .attendance-progress {
        height: 100%;
        width: 0;
        transition: width 0.3s ease-out;
    }

    .high-attendance {
        background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
    }

    .medium-attendance {
        background: linear-gradient(90deg, var(--warning) 0%, #d97706 100%);
    }

    .low-attendance {
        background: linear-gradient(90deg, var(--danger) 0%, #b91c1c 100%);
    }

    .attendance-percent {
        font-family: var(--font-mono);
        font-size: 0.85rem;
        color: var(--text-muted);
        min-width: 50px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .empty-state-icon {
        font-size: 3rem;
        color: var(--text-muted);
    }

    /* Modal animation */
    .modal {
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
        }

        .export-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-3);
        }

        .attendance-display {
            flex-direction: column;
            align-items: flex-start;
        }

        .attendance-bar {
            width: 100%;
        }
    }
</style>
</body>
</html>